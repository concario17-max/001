<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìº˜ë¦°ë” ë³€í™˜ê¸° V7 (ì´ë¯¸ì§€ ê°•ë ¥ ë§¤ì¹­)</title>
    <style>
        body { font-family: "Pretendard", -apple-system, sans-serif; padding: 20px; background: #f5f5f7; color: #333; }
        .box { background: white; padding: 40px; border-radius: 16px; max-width: 600px; margin: 0 auto; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; color: #111; }
        .badge { background: #d32f2f; color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; vertical-align: middle; }
        button { background: #000000; color: white; border: none; padding: 16px 32px; font-size: 1.1rem; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.2s; }
        button:hover { background: #333; transform: translateY(-2px); }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #logArea { margin-top: 20px; text-align: left; font-size: 0.85rem; background: #eee; padding: 15px; border-radius: 8px; height: 150px; overflow-y: auto; white-space: pre-wrap; font-family: monospace; }
        .step { margin: 20px 0; padding: 20px; border: 2px dashed #ddd; border-radius: 12px; background: #fafafa; }
        .step.active { border-color: #000; background: #fff; }
        .success-text { color: #2e7d32; font-weight: bold; }
        .error-text { color: #d32f2f; font-weight: bold; }
    </style>
</head>
<body>

<div class="box">
    <h2>ğŸ“… ìº˜ë¦°ë” ë³€í™˜ê¸° V7 <span class="badge">ì´ë¯¸ì§€ON</span></h2>
    <p>ë°°ê²½: <strong>ê²€ì •(#000)</strong> / ê¸€ì”¨: <strong>í°ìƒ‰(#FFF)</strong><br>ì œëª© ì• ìˆ«ìë¥¼ ì°¾ì•„ <strong>gif, jpg, png</strong> ë‹¤ ì—°ê²°í•©ë‹ˆë‹¤.</p>

    <div class="step" id="step1">
        <p><strong>íŒŒì¼ ì„ íƒ</strong> (2ê°œ ë™ì‹œì— ì„ íƒ)</p>
        <input type="file" id="fileInput" multiple accept=".ics">
    </div>

    <div class="step">
        <button id="convertBtn" onclick="processFiles()" disabled>ë³€í™˜ ì‹œì‘</button>
    </div>

    <div id="logArea">ëŒ€ê¸° ì¤‘...</div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const convertBtn = document.getElementById('convertBtn');
    const logArea = document.getElementById('logArea');
    const step1 = document.getElementById('step1');

    function log(msg, type='normal') {
        const div = document.createElement('div');
        div.textContent = msg;
        if (type === 'success') div.className = 'success-text';
        if (type === 'error') div.className = 'error-text';
        logArea.appendChild(div);
        logArea.scrollTop = logArea.scrollHeight;
    }

    fileInput.addEventListener('change', () => {
        logArea.innerHTML = ''; 
        if (fileInput.files.length > 0) {
            step1.classList.add('active');
            convertBtn.disabled = false;
            convertBtn.innerText = `${fileInput.files.length}ê°œì˜ íŒŒì¼ ë³€í™˜í•˜ê¸°`;
            log(`ğŸ“‚ ${fileInput.files.length}ê°œì˜ íŒŒì¼ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.`);
        } else {
            step1.classList.remove('active');
            convertBtn.disabled = true;
            log("íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        }
    });

    async function processFiles() {
        const files = fileInput.files;
        let allEvents = {};

        log("--- ë¶„ì„ ì‹œì‘ ---");

        for (let file of files) {
            try {
                const text = await file.text();
                const events = parseICS(text);
                
                for (let dateKey in events) {
                    if (allEvents[dateKey]) {
                        allEvents[dateKey].title += " <br> " + events[dateKey].title;
                        allEvents[dateKey].desc += "\n\n" + events[dateKey].desc; 
                    } else {
                        allEvents[dateKey] = events[dateKey];
                    }
                }
                log(`âœ… [${file.name}] ë°ì´í„° ì¶”ì¶œ ì™„ë£Œ`, 'success');
            } catch (e) {
                log(`âŒ [${file.name}] ì˜¤ë¥˜: ${e}`, 'error');
            }
        }

        if (Object.keys(allEvents).length === 0) {
            alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        log(`ğŸ‰ ë³€í™˜ ì™„ë£Œ! index.htmlì„ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.`, 'success');
        const htmlContent = generateFinalHTML(allEvents);
        downloadFile("index.html", htmlContent);
    }

    function parseDateStr(str) {
        if (!str || str.length < 8) return null;
        const y = parseInt(str.substring(0, 4));
        const m = parseInt(str.substring(4, 6)) - 1; 
        const d = parseInt(str.substring(6, 8));
        return new Date(y, m, d);
    }

    function parseICS(content) {
        const lines = content.split(/\r\n|\n|\r/);
        let events = {};
        let currentEvent = {};
        let inEvent = false;

        let unfoldedLines = [];
        for (let line of lines) {
            if (line.startsWith(' ')) {
                if (unfoldedLines.length > 0) unfoldedLines[unfoldedLines.length - 1] += line.substring(1);
            } else {
                unfoldedLines.push(line.trim());
            }
        }

        for (let line of unfoldedLines) {
            if (line.startsWith('BEGIN:VEVENT')) { inEvent = true; currentEvent = {}; continue; }
            if (line.startsWith('END:VEVENT')) {
                inEvent = false;
                if (currentEvent['DTSTART'] && currentEvent['SUMMARY']) {
                    let startRaw = currentEvent['DTSTART'].split(':')[1] || currentEvent['DTSTART'];
                    let endRaw = currentEvent['DTEND'] ? (currentEvent['DTEND'].split(':')[1] || currentEvent['DTEND']) : null;

                    let startDate = parseDateStr(startRaw);
                    let endDate = endRaw ? parseDateStr(endRaw) : new Date(startDate);
                    if (!endRaw) { endDate = new Date(startDate); endDate.setDate(endDate.getDate() + 1); }

                    let title = currentEvent['SUMMARY'];
                    let desc = currentEvent['DESCRIPTION'] || '';
                    desc = desc.replace(/\\n/g, '\n').replace(/\\,/g, ',').replace(/\\;/g, ';');

                    let loopDate = new Date(startDate);
                    while (loopDate < endDate) {
                        let key = `${loopDate.getMonth() + 1}-${loopDate.getDate()}`;
                        events[key] = { title: title, desc: desc };
                        loopDate.setDate(loopDate.getDate() + 1);
                        if ((loopDate - startDate) > 31536000000) break; 
                    }
                }
                continue;
            }
            if (inEvent) {
                let idx = line.indexOf(':');
                if (idx > -1) {
                    let key = line.substring(0, idx).split(';')[0];
                    currentEvent[key] = line.substring(idx + 1);
                }
            }
        }
        return events;
    }

    function generateFinalHTML(dailyData) {
        let jsonStr = "const dailyData = {\n";
        for (let key in dailyData) {
            let item = dailyData[key];
            let safeTitle = item.title.replace(/"/g, '\\"');
            let safeDesc = item.desc.replace(/"/g, '\\"').replace(/\n/g, '\\n');
            jsonStr += `            "${key}": { title: "${safeTitle}", desc: "${safeDesc}" },\n`;
        }
        jsonStr += "        };";

        return `<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜¤ëŠ˜ì˜ ë©”ì‹œì§€</title>
    <style>
        body { 
            background-color: #000000 !important; 
            color: #ffffff !important;           
            font-family: "Pretendard", -apple-system, sans-serif; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
            padding: 20px; 
            box-sizing: border-box; 
        }
        .container { max-width: 500px; width: 100%; line-height: 1.6; }
        .date-label { font-size: 1rem; color: #a0a0a0; margin-bottom: 5px; }
        .content-block { margin-bottom: 40px; border-bottom: 1px solid #333; padding-bottom: 30px; }
        .content-block:last-child { border-bottom: none; }
        .title { 
            font-size: 1.5rem;   
            font-weight: bold; 
            margin-bottom: 15px; 
            word-break: keep-all; 
            color: #ffffff;      
            border-left: 4px solid #4caf50; 
            padding-left: 12px; 
        }
        .description { 
            font-size: 1.1rem;   
            color: #eeeeee;      
            white-space: pre-line; 
            line-height: 1.8;    
        }
        .img-box { margin-top: 20px; border-radius: 8px; overflow: hidden; margin-bottom: 20px; }
        .img-box img { width: 100%; height: auto; display: block; }
    </style>
</head>
<body>
    <div class="container">
        <div class="date-label" id="date-display"></div>
        <div id="content-area"></div>
    </div>
    <script>
        ${jsonStr}

        function updateDailyContent() {
            const now = new Date();
            const month = now.getMonth() + 1;
            const day = now.getDate();
            const key = \`\${month}-\${day}\`;
            
            const content = dailyData[key];
            const dateEl = document.getElementById('date-display');
            const areaEl = document.getElementById('content-area');
            
            dateEl.textContent = \`\${month}ì›” \${day}ì¼\`;
            areaEl.innerHTML = "";

            if (content) {
                const titles = content.title.split(" <br> ");
                const descs = content.desc.split("\\n\\n");

                let html = "";
                for(let i=0; i < titles.length; i++) {
                    let t = titles[i] || "";
                    let d = descs[i] || descs[0] || "";
                    
                    // [ê°•ë ¥í•´ì§„ ì´ë¯¸ì§€ ì°¾ê¸° ë¡œì§]
                    // 1. ì œëª©ì—ì„œ 'ë§¨ ì•ì— ìˆëŠ” ìˆ«ì'ë§Œ ì¶”ì¶œ (ì˜ˆ: "06. ì†¡" -> "06")
                    let imgTag = "";
                    let numberMatch = t.match(/^(\\d+)/); 
                    
                    if (numberMatch) {
                        let fileNum = numberMatch[1];
                        // 2. gif -> jpg -> png ìˆœì„œë¡œ ì‹œë„í•´ë³´ê³  ë˜ëŠ” ê±° ë³´ì—¬ì¤Œ (í™•ì¥ì ê±±ì • ë!)
                        // onerror ë§ˆë²•ì„ ì‚¬ìš©í•´ì„œ í•˜ë‚˜ë¼ë„ ê±¸ë¦¬ë©´ ëœ¨ê²Œ í•¨
                        imgTag = \`<div class="img-box">
                            <img src="\${fileNum}.gif" 
                                 onerror="this.src='\${fileNum}.GIF'; this.onerror=function(){ this.src='\${fileNum}.jpg'; this.onerror=function(){ this.src='\${fileNum}.png'; this.onerror=function(){this.style.display='none';} } }"
                                 alt="Image">
                        </div>\`;
                    }

                    html += \`
                    <div class="content-block">
                        <div class="title">\${t}</div>
                        \${imgTag}
                        <div class="description">\${d}</div>
                    </div>
                    \`;
                }
                areaEl.innerHTML = html;

            } else {
                areaEl.innerHTML = "<div class='title' style='color:#fff'>ê¸°ë¡ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
            }
        }
        updateDailyContent();
    <\/script>
</body>
</html>`;
    }

    function downloadFile(filename, content) {
        const element = document.createElement('a');
        element.setAttribute('href', 'data:text/html;charset=utf-8,' + encodeURIComponent(content));
        element.setAttribute('download', filename);
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
    }
</script>

</body>
</html>